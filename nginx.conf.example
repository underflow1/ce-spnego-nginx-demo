# Пример server block для Nginx с SPNEGO.
# Скопировать в /etc/nginx/sites-available/ и сделать symlink в sites-enabled.
# Модуль libnginx-mod-http-auth-spnego должен быть установлен и включён.

server {
    listen 0.0.0.0:80;
    server_name app.example.com;

    # PAC в AD-токенах может быть большим
    large_client_header_buffers 8 32k;

    location / {
        auth_gss on;
        auth_gss_keytab /etc/krb5.keytab;
        auth_gss_format_full on;   # X-Remote-User = user@REALM (иначе только user)
        auth_gss_allow_basic_fallback off;

        # Модуль подменяет Authorization на fake basic auth — сбрасываем
        proxy_set_header Authorization "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Remote-User $remote_user;

        proxy_pass http://127.0.0.1:8080;
    }
}
